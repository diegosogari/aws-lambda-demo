name: Deploy service to AWS Lambda

on:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/deploy-to-aws.yml'
      - '**/*.py'
      - 'requirements.txt'

jobs:
  package-and-upload:
    name: Package the code and upload it to Amazon S3
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    env:
      S3_BUCKET: lambda-20231102013812622900000001
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v2
        id: paths
        with:
          filters: |
            code:
              - '**/*.py'
            dependencies:
              - 'requirements.txt'
      - uses: actions/setup-python@v4.7.1
        with:
          python-version: '3.10'
          cache: 'pip'
      - uses: aws-actions/configure-aws-credentials@v4.0.1
        with:
          aws-region: us-east-1
          role-to-assume: arn:aws:iam::574563284495:role/gha
      - run: sudo apt install -y zip

      - if: steps.paths.outputs.code == 'true'
        name: Package and upload the code
        run: |
          pip install -r requirements.txt
          python -m py_compile *.py
          zip code.zip *.py */*.py
          aws s3api put-object --bucket $S3_BUCKET --key layers/demo/code.zip --body code.zip --checksum-algorithm SHA256

      - if: steps.paths.outputs.dependencies == 'true'
        name: Package and upload the dependencies
        run: |
          pip install -r requirements.txt --target python --platform manylinux2014_x86_64 --only-binary :all:
          zip -r dependencies.zip python
          aws s3api put-object --bucket $S3_BUCKET --key layers/demo/dependencies.zip --body dependencies.zip --checksum-algorithm SHA256
